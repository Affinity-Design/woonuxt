# Data Files Audit & KV Storage Migration Plan

**Date:** November 13, 2025  
**Issue:** Files in `data/` folder are local-only and not accessible on Cloudflare Pages deployment

## Executive Summary

Currently, **13 files** in the `data/` folder are generated during build. Some are needed at **build-time only** (for Nuxt config), while others are needed at **runtime** (for API endpoints). Runtime files must be stored in **Cloudflare KV** to be accessible on production.

---

## Complete File Inventory

### 1. **sitemap-data.json** (500 KB - 1,750 routes)
- **Generated by:** `scripts/build-sitemap.js`
- **Used by:** 
  - `server/api/sitemap.xml.ts` (runtime - CRITICAL)
- **Purpose:** Complete sitemap with all products, categories, blog posts
- **Status:** âš ï¸ **NEEDS KV STORAGE** - API endpoint fails without it
- **Priority:** ğŸ”´ **CRITICAL**

### 2. **product-seo-meta.json** (1.2 MB - SEO metadata for 1,668 products)
- **Generated by:** `scripts/build-sitemap.js`
- **Used by:** 
  - Currently not used in runtime (future feature)
- **Purpose:** Pre-generated Canadian SEO titles/descriptions for products
- **Status:** âœ… Build-time only (for now)
- **Priority:** ğŸŸ¡ Low (future optimization)

### 3. **product-routes.json** (1,668 routes)
- **Generated by:** `scripts/build-sitemap.js`
- **Used by:** 
  - `nuxt.config.ts` (build-time only)
- **Purpose:** Product URLs for prerendering (limited to 500 for performance)
- **Status:** âœ… Build-time only
- **Priority:** ğŸŸ¢ No action needed

### 4. **category-routes.json** (67 routes)
- **Generated by:** `scripts/build-sitemap.js` and `scripts/build-all-routes.js`
- **Used by:** 
  - `nuxt.config.ts` (build-time only)
- **Purpose:** Category URLs for prerendering
- **Status:** âœ… Build-time only
- **Priority:** ğŸŸ¢ No action needed

### 5. **blog-routes.json** (8 routes)
- **Generated by:** `scripts/build-sitemap.js` and `scripts/build-blog-routes.js`
- **Used by:** 
  - `nuxt.config.ts` (build-time only)
  - `server/api/debug/content.ts` (debug endpoint)
- **Purpose:** Blog URLs for prerendering
- **Status:** âœ… Build-time only
- **Priority:** ğŸŸ¢ No action needed

### 6. **blog-redirects.json** (slug â†’ /blog/slug mappings)
- **Generated by:** `scripts/build-all-routes.js`
- **Used by:** 
  - `nuxt.config.ts` (build-time - merged into routeRules)
  - `server/api/debug/content.ts` (debug endpoint)
- **Purpose:** SEO-friendly redirects for blog posts
- **Status:** âœ… Build-time only
- **Priority:** ğŸŸ¢ No action needed

### 7. **blog-slugs.json** (list of blog post slugs)
- **Generated by:** `scripts/build-all-routes.js`
- **Used by:** 
  - `scripts/generate-route-rules.js` (build-time helper)
- **Purpose:** Helper file for route generation
- **Status:** âœ… Build-time only
- **Priority:** ğŸŸ¢ No action needed

### 8. **products-list.json** (search index - ~500 KB)
- **Generated by:** `scripts/build-products-cache.js`
- **Used by:** 
  - `composables/useSearch.ts` (LOCAL DEV ONLY - has fallback)
  - `server/api/search-products.get.ts` (runtime - reads from KV)
- **Purpose:** Product search index for Fuse.js
- **Status:** âš ï¸ **ALREADY IN KV** but useSearch.ts imports it locally
- **Priority:** ğŸŸ¡ Medium (fix local import)

### 9. **products-list** (plain text - no .json extension)
- **Generated by:** `scripts/build-products-cache.js`
- **Used by:** 
  - Cloudflare KV via `scripts/cache-warmer.js`
- **Purpose:** Product URLs for cache warming
- **Status:** âœ… **ALREADY IN KV** as `products-list` key
- **Priority:** ğŸŸ¢ No action needed

### 10. **categories-list** (plain text - no .json extension)
- **Generated by:** `scripts/build-categories-cache.js`
- **Used by:** 
  - Cloudflare KV via `scripts/cache-warmer.js`
- **Purpose:** Category URLs for cache warming
- **Status:** âœ… **ALREADY IN KV** as `categories-list` key
- **Priority:** ğŸŸ¢ No action needed

### 11. **woo-order-keys.json**
- **Generated by:** Unknown (possibly manual or old script)
- **Used by:** NOT FOUND in codebase
- **Purpose:** Unknown (legacy file?)
- **Status:** â“ Orphaned file
- **Priority:** ğŸŸ¢ Safe to delete?

### 12. **blog-redirects.js** (JavaScript module format)
- **Generated by:** Unknown
- **Used by:** NOT FOUND in codebase (JSON version is used)
- **Purpose:** Legacy format of blog-redirects.json
- **Status:** â“ Orphaned file
- **Priority:** ğŸŸ¢ Safe to delete

### 13. **data/old/** (directory with archived files)
- **Generated by:** Various scripts (historical)
- **Used by:** NOT FOUND in codebase
- **Purpose:** Backup/archive
- **Status:** â“ Orphaned directory
- **Priority:** ğŸŸ¢ Safe to delete

---

## Current KV Storage Status

### NUXT_SCRIPT_DATA Namespace (Already Configured)
âœ… Currently stores:
- `products-list` (product URLs for cache warmer)
- `categories-list` (category URLs for cache warmer)
- `cache-warmer-state` (cache warming state)

### NUXT_CACHE Namespace (Already Configured)
âœ… Used for:
- Route caching (ISR-style)
- Product pages (72 hours)
- Category pages (7 days)

---

## Migration Plan

### Phase 1: Critical Fix (sitemap-data.json)

**Problem:** `/api/sitemap.xml` endpoint returns 204 No Content on production because `data/sitemap-data.json` doesn't exist.

**Solution:**
1. Modify `scripts/build-sitemap.js` to upload `sitemap-data.json` to KV
2. Modify `server/api/sitemap.xml.ts` to read from KV instead of filesystem

**Files to modify:**
- `scripts/build-sitemap.js` - Add KV upload after file generation
- `server/api/sitemap.xml.ts` - Read from `useStorage('script_data')` instead of `fs.readFileSync`

**Implementation:**
```javascript
// In build-sitemap.js, add after writeFileSync:
await uploadToKV('sitemap-data', sitemapData);

// In sitemap.xml.ts, replace fs.readFileSync with:
const storage = useStorage('script_data');
const sitemapData = await storage.getItem('sitemap-data');
```

### Phase 2: Fix useSearch.ts Local Import

**Problem:** `composables/useSearch.ts` imports `data/products-list.json` directly, which won't work if file is missing.

**Solution:**
The composable already has proper fallback logic:
- Local dev: Uses imported JSON file
- Production: Uses `/api/search-products` (which reads from KV)

**Action Required:**
- Ensure `products-list.json` is in `.gitignore` or document it's dev-only
- OR: Remove local import entirely and always use API endpoint (even locally)

### Phase 3: Cleanup Orphaned Files

**Safe to delete:**
- `data/woo-order-keys.json` (not used)
- `data/blog-redirects.js` (JSON version is used)
- `data/old/` (archived files)

---

## Updated Build Process Flow

```
npm run build
â”œâ”€â”€ 1. scripts/build-sitemap.js
â”‚   â”œâ”€â”€ Fetches products, categories, blog posts via GraphQL
â”‚   â”œâ”€â”€ Generates sitemap-data.json (1,750 routes)
â”‚   â”œâ”€â”€ Generates product-seo-meta.json (SEO metadata)
â”‚   â”œâ”€â”€ Generates product-routes.json (for Nuxt config)
â”‚   â”œâ”€â”€ Generates category-routes.json (for Nuxt config)
â”‚   â”œâ”€â”€ Generates blog-routes.json (for Nuxt config)
â”‚   â””â”€â”€ ğŸ”´ NEW: Upload sitemap-data.json to KV
â”‚
â”œâ”€â”€ 2. scripts/build-products-cache.js
â”‚   â”œâ”€â”€ Generates products-list (plain text)
â”‚   â”œâ”€â”€ Generates products-list.json (search index)
â”‚   â””â”€â”€ âœ… Already uploads to KV
â”‚
â”œâ”€â”€ 3. scripts/build-categories-cache.js
â”‚   â”œâ”€â”€ Generates categories-list (plain text)
â”‚   â””â”€â”€ âœ… Already uploads to KV
â”‚
â””â”€â”€ 4. nuxt build
    â””â”€â”€ Reads *-routes.json files for prerendering
```

---

## KV Namespace Structure (After Migration)

### NUXT_SCRIPT_DATA
```
â”œâ”€â”€ products-list          (URLs for cache warmer)
â”œâ”€â”€ categories-list        (URLs for cache warmer)
â”œâ”€â”€ cache-warmer-state     (warming progress)
â””â”€â”€ sitemap-data           ğŸ”´ NEW (complete sitemap)
```

### NUXT_CACHE
```
â””â”€â”€ (dynamic route cache - managed by Nitro)
```

---

## Testing Plan

### 1. Local Testing
```bash
# Generate all data files
npm run build-sitemap

# Verify files exist
ls data/

# Test sitemap endpoint locally
curl http://localhost:3000/api/sitemap.xml
```

### 2. Test Branch Deployment
```bash
# Deploy to test branch
git push origin test

# Wait for Cloudflare build
# Check build logs for KV upload success

# Test sitemap endpoint on test
curl https://test.proskatersplace.ca/api/sitemap.xml

# Verify 1,750 routes returned (not 22)
```

### 3. Production Deployment
```bash
# Merge to master after test passes
git merge test
git push origin master

# Submit to Google Search Console
https://proskatersplace.ca/sitemap.xml
```

---

## Estimated Impact

### Before Migration
- âŒ Sitemap endpoint: 22 routes (static fallback)
- âŒ No product pages in sitemap
- âŒ Poor SEO indexing

### After Migration
- âœ… Sitemap endpoint: 1,750 routes
- âœ… All products indexed
- âœ… Google can crawl entire site
- âœ… Improved SEO performance

---

## Next Steps

1. âœ… Create this audit document
2. â³ Implement Phase 1: Sitemap KV storage
3. â³ Test on test branch
4. â³ Implement Phase 2: Fix useSearch.ts
5. â³ Implement Phase 3: Cleanup orphaned files
6. â³ Deploy to production
7. â³ Submit sitemap to Google Search Console

---

## Questions for Review

1. Should we delete `woo-order-keys.json` or is it used somewhere we missed?
2. Should `product-seo-meta.json` be uploaded to KV for future use (product pages can pull pre-generated SEO)?
3. Should we remove the local file import in `useSearch.ts` and always use API endpoint?

